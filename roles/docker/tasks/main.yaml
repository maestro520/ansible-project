---
# 0Ô∏è‚É£ Remove conflicting Podman Docker package
- name: Remove podman-docker to avoid conflict
  package:
    name: podman-docker
    state: absent

# 1Ô∏è‚É£ Add Docker CE official repository
- name: Add Docker CE repository
  yum_repository:
    name: docker-ce
    description: Docker CE Repository
    baseurl: https://download.docker.com/linux/centos/9/x86_64/stable/
    gpgcheck: yes
    gpgkey: https://download.docker.com/linux/centos/gpg
    state: present

# 2Ô∏è‚É£ Install Docker CE packages
- name: Install Docker CE packages
  package:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
    state: present

# 3Ô∏è‚É£ Ensure Docker service is running
- name: Start and enable Docker service
  systemd:
    name: docker
    state: started
    enabled: yes

# 4Ô∏è‚É£ Install required utilities
- name: Install required utilities
  package:
    name:
      - curl
      - wget
      - tar
    state: present

# 5Ô∏è‚É£ Create app build directory
- name: Create app build directory
  file:
    path: /tmp/docker_app
    state: directory
    mode: "0755"

# 6Ô∏è‚É£ Download lab-app.tgz
- name: Download lab-app.tgz
  get_url:
    url: https://aws-tc-largeobjects.s3-us-west-2.amazonaws.com/CUR-TF-200-ACACAD/studentdownload/lab-app.tgz
    dest: /tmp/docker_app/lab-app.tgz
    mode: "0644"

# 7Ô∏è‚É£ Create folder for extracted lab-app
- name: Create lab-app directory for extraction
  file:
    path: /tmp/docker_app/lab-app
    state: directory
    mode: "0755"

# 8Ô∏è‚É£ Extract lab-app into the folder
- name: Extract lab-app
  unarchive:
    src: /tmp/docker_app/lab-app.tgz
    dest: /tmp/docker_app/lab-app
    remote_src: yes

# 9Ô∏è‚É£ Create Dockerfile
- name: Create Dockerfile
  copy:
    dest: /tmp/docker_app/Dockerfile
    content: |
      FROM centos:8

      # Install required packages
      RUN dnf install -y httpd php mysql php-mysql && dnf clean all

      # Copy lab app
      COPY lab-app /var/www/html/

      # Set ownership
      RUN chown apache:root /var/www/html/rds.conf.php

      # Expose port 80
      EXPOSE 80

      # Start Apache
      CMD ["/usr/sbin/httpd", "-D", "FOREGROUND"]

# üîπ Build Docker image
- name: Build Docker image
  command: docker build -t lab-app:latest /tmp/docker_app
  args:
    creates: /var/lib/docker/image/overlay2/repositories.json

# üîπ Initialize Docker Swarm on manager node
- name: Initialize Docker Swarm on manager
  shell: docker swarm init
  register: swarm_init
  failed_when: false
  changed_when: "'This node is already part of a swarm' not in swarm_init.stdout"
  when: inventory_hostname == "prdx-dworker101.ziyotek.local"

# üîπ Get Swarm join token for worker nodes
- name: Get Swarm join token for workers
  shell: docker swarm join-token worker -q
  register: swarm_token
  when: inventory_hostname == "prdx-dworker101.ziyotek.local"

# üîπ Join worker node to Swarm
- name: Join worker node to Swarm
  shell: docker swarm join --token {{ hostvars['prdx-dworker101.ziyotek.local'].swarm_token.stdout }} 192.168.220.208:2377
  when: inventory_hostname == "prdx-dworker102.ziyotek.local"

# üîπ Deploy Docker service with 3 replicas (manager only)
- name: Deploy Docker service with 3 replicas
  shell: |
    docker service ls | grep lab_app || \
    docker service create --name lab_app_web --replicas 3 -p 80:80 lab-app:latest
  when: inventory_hostname == "prdx-dworker101.ziyotek.local"
