---
# Remove conflicting Podman Docker package
- name: Remove podman-docker to avoid conflict
  package:
    name: podman-docker
    state: absent

# Add Docker CE official repository
- name: Add Docker CE repository
  yum_repository:
    name: docker-ce
    description: Docker CE Repository
    baseurl: https://download.docker.com/linux/centos/9/x86_64/stable/
    gpgcheck: yes
    gpgkey: https://download.docker.com/linux/centos/gpg
    state: present

# Install Docker CE packages
- name: Install Docker CE packages
  package:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
    state: present

# Ensure Docker service is running
- name: Start and enable Docker service
  systemd:
    name: docker
    state: started
    enabled: yes

# Install required utilities
- name: Install required utilities
  package:
    name:
      - curl
      - wget
      - tar
    state: present

# Create app build directory
- name: Create app build directory
  file:
    path: /tmp/docker_app
    state: directory
    mode: "0755"

# Download lab-app.tgz
- name: Download lab-app.tgz
  get_url:
    url: https://aws-tc-largeobjects.s3-us-west-2.amazonaws.com/CUR-TF-200-ACACAD/studentdownload/lab-app.tgz
    dest: /tmp/docker_app/lab-app.tgz
    mode: "0644"

# Create folder for extracted lab-app
- name: Create lab-app directory for extraction
  file:
    path: /tmp/docker_app/lab-app
    state: directory
    mode: "0755"

# Extract lab-app into the folder
- name: Extract lab-app
  unarchive:
    src: /tmp/docker_app/lab-app.tgz
    dest: /tmp/docker_app/lab-app
    remote_src: yes

- name: Create Dockerfile
  copy:
    dest: /tmp/docker_app/Dockerfile
    content: |
      FROM rockylinux:9

      RUN dnf install -y httpd php php-mysqli mariadb && dnf clean all

      COPY lab-app /var/www/html/
      RUN chown -R apache:apache /var/www/html

      EXPOSE 80
      CMD ["/usr/sbin/httpd", "-D", "FOREGROUND"]

# Build Docker image
- name: Build Docker image
  command: docker build -t lab-app:latest /tmp/docker_app
  args:
    creates: /var/lib/docker/image/overlay2/repositories.json

# Initialize Docker Swarm on manager node
- name: Initialize Docker Swarm on manager
  shell: docker swarm init --advertise-addr 192.168.220.207
  register: swarm_init
  failed_when: false
  when: inventory_hostname == "prdx-dprimary101.ziyotek.local"

# Get Swarm join token for worker nodes
- name: Get Swarm worker token from manager
  shell: docker swarm join-token worker -q
  register: worker_token_output
  when: inventory_hostname == "prdx-dprimary101.ziyotek.local"

# Join worker node to Swarm
- name: Workers join Docker Swarm
  shell: |
    docker swarm join \
      --token {{ hostvars['prdx-dprimary101.ziyotek.local'].worker_token_output.stdout }} \
      {{ hostvars['prdx-dprimary101.ziyotek.local'].ansible_host }}:2377 \
    || true
  when:
    - inventory_hostname != "prdx-dprimary101.ziyotek.local"


# Deploy Docker service with 3 replicas (manager only)
- name: Deploy Docker service on manager
  shell: |
    docker service ls | grep lab_app_web || \
    docker service create --name lab_app_web --replicas 3 -p 80:80 lab-app:latest
  when: inventory_hostname == "prdx-dprimary101.ziyotek.local"